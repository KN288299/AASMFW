# 员工数据重置指南

这个指南将帮助你安全地重置服务器和数据库中的员工数据。

## 🚨 重要警告

**此操作不可逆！请在执行前确保：**
- 你真的想要删除所有员工数据
- 已经备份了重要数据（如果需要的话）
- 理解操作的后果

## 📋 重置脚本功能

`reset-staff-data.js` 脚本可以清理：

✅ **数据库数据**
- 所有员工记录
- 员工ID计数器
- 批次导入记录

✅ **文件系统**
- 员工图片文件 (`uploads/images/`)
- 临时导入目录 (`uploads/batch-temp/`, `uploads/admin-temp/`)
- 缓存和日志文件

## 🛠️ 使用方法

### 1. 完全重置（推荐）
删除所有员工相关的数据和文件：

```bash
node reset-staff-data.js
```

这会提示你两次确认：
1. 输入 `yes` 确认操作
2. 输入 `DELETE` 最终确认

### 2. 仅重置数据库
只删除数据库记录，保留图片文件：

```bash
node reset-staff-data.js --database-only
```

### 3. 仅清理文件
只删除图片文件和临时目录，保留数据库记录：

```bash
node reset-staff-data.js --files-only
```

### 4. 查看帮助
```bash
node reset-staff-data.js --help
```

## 📊 重置过程详解

### 第一阶段：数据库清理
```
🗄️ 清理数据库中的员工数据...
📊 找到 X 个员工记录
✅ 已删除 X 个员工记录
✅ 已重置员工ID计数器
```

### 第二阶段：文件清理
```
🖼️ 清理员工图片文件...
📊 找到 X 个图片文件
🗑️ 删除图片: employee-xxx.jpg
✅ 已删除 X 个图片文件
```

### 第三阶段：临时目录清理
```
📁 清理临时目录...
🗑️ 删除临时目录: batch-temp
🗑️ 删除临时目录: admin-temp
✅ 已清理 X 个临时目录
```

### 第四阶段：验证结果
```
🔍 验证清理结果...
📊 数据库员工记录数: 0
📊 剩余图片文件数: 0
📊 剩余临时目录数: 0
✅ 清理完成！所有员工数据已成功删除
```

## ⚡ 快速重置流程

如果你想要快速重新开始：

```bash
# 1. 完全重置所有数据
node reset-staff-data.js

# 2. 重新启动服务器
npm start

# 3. 重新导入员工数据
# 通过管理界面上传新的员工数据
```

## 🔧 故障排除

### 问题1：数据库连接失败
```
❌ 数据库连接失败: MongoNetworkError
```

**解决方案：**
- 确保MongoDB服务正在运行
- 检查 `.env` 文件中的 `MONGO_URI` 配置
- 确保数据库服务器可访问

### 问题2：文件删除失败
```
❌ 删除图片失败 xxx.jpg: ENOENT
```

**解决方案：**
- 文件可能已经被删除（正常情况）
- 检查文件权限
- 确保没有其他进程在使用这些文件

### 问题3：权限问题
```
❌ 删除临时目录失败: EACCES
```

**解决方案：**
- 在Windows上以管理员身份运行
- 在Linux/Mac上使用 `sudo`
- 检查目录权限

## 📝 重置后的清理检查

重置完成后，你可以手动验证：

1. **检查数据库**：
   ```bash
   # 连接到MongoDB
   mongo homeservice
   db.staffs.count()  # 应该返回 0
   ```

2. **检查文件系统**：
   ```bash
   # 检查图片目录
   ls uploads/images/
   
   # 检查临时目录
   ls uploads/batch-temp/  # 应该不存在
   ls uploads/admin-temp/  # 应该不存在
   ```

## 🎯 最佳实践

1. **在开发环境中测试**
   - 先在开发环境运行重置脚本
   - 确认一切工作正常后再在生产环境使用

2. **备份重要数据**
   - 如果有重要的员工数据，先导出备份
   - 可以使用 `mongoexport` 导出员工集合

3. **分步骤重置**
   - 可以先用 `--database-only` 只重置数据库
   - 然后用 `--files-only` 清理文件
   - 这样可以更好地控制重置过程

## 🚀 重置后重新开始

重置完成后，你的系统就像全新安装一样：
- 没有任何员工数据
- 图片目录是空的
- 可以重新导入员工数据
- 所有ID会从1开始重新计数

现在你可以安全地重新开始员工数据管理了！
